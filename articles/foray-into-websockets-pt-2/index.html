<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><link href="/img/favicon.ico" rel="icon" type="image/x-icon"/></head><body><div id="___gatsby"><div data-reactroot="" data-reactid="1" data-react-checksum="-1456604134"><nav class="navbar navbar-expand navbar-dark flex-column flex-md-row bg-primary" data-reactid="2"><div class="container" data-reactid="3"><a class="text-center" href="/" data-reactid="4"><h1 class="navbar-brand mb-0" data-reactid="5">Trevor Richardson</h1></a><div class="navbar-nav-scroll" data-reactid="6"><ul class="navbar-nav bd-navbar-nav flex-row" data-reactid="7"><li class="nav-item" data-reactid="8"><a class="nav-link" href="/" data-reactid="9">Home</a></li><li class="nav-item" data-reactid="10"><a class="nav-link" href="/profile/" data-reactid="11">Profile</a></li></ul></div><div class="navbar-nav flex-row ml-md-auto d-none d-md-flex" data-reactid="12"></div></div></nav><div data-reactid="13"><div class="container" data-reactid="14"><div class="articles col-md-12" data-reactid="15"><div class="article-wrap" data-reactid="16"><div class="page-header" data-reactid="17"><a style="box-shadow:none;" href="/articles/foray-into-websockets-pt-2" data-reactid="18"><h1 data-reactid="19">Foray into websockets - pt 2</h1><time datetime="2021/12/13" data-reactid="20">2021/12/13</time></a><span class="badge badge-primary text-white" data-reactid="21">architecture</span></div><div class="page-content" data-reactid="22"><p>So, <a href="/articles/foray-into-websockets">part 1</a> actually went much better than I would've expected. I had no idea the raw web apis were so friendly at least to get something basic working. Essentially once you have a connection you're off to the races. Following that up with a pub/sub topic subscription and firing off new notifications whenever they came was equally straightforward. Now, after I had that success I came away with some questions (which is always the big win of hacking on something new).</p>
<ol>
<li>What is this <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism">upgrade thing</a> some docs reference as the "Web" in websockets (can't seem to find direct reference), but the <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications#examples">MDN docs do reference this upgrade</a> path as the way a browser creates them.</li>
<li>What does it look like to turn this single connection into production worthy?
a. What happenes when the network drops?</li>
<li>How do you manage lots of persistent connections?
a. Any established best-practice or "websocket servers" that manage all this for you?</li>
<li>Where in the flow do we establish and link who is who for a new connection attempt to the server?</li>
</ol>
<h2>What is this http "upgrade" thing?</h2>
<p>Direct quote from <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications#examples">the MDN docs</a>:</p>
<blockquote>
<p>Establishing a WebSocket relies on the HTTP Upgrade mechanism, so the request for the protocol upgrade is implicit when we address the web server as ws://www.example.com or wss://www.example.com.</p>
</blockquote>
<p>I've seen elsewhere this is the "web" in websockets. Primarily the fact that the initial request is regular http but is sent with the <code class="language-text">upgrade</code> protocol which indicates to the server it would like to upgrade to a websocket connection.</p>
<p>Ew, some interesting info from the mdn <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism">Protocol Upgrade Mechanism</a>:</p>
<blockquote>
<p>This mechanism is optional; it cannot be used to insist on a protocol change. Implementations can choose not to take advantage of an upgrade even if they support the new protocol, and in practice, this mechanism is used mostly to bootstrap a WebSockets connection.</p>
<p>Note also that HTTP/2 explicitly disallows the use of this mechanism; it is specific to HTTP/1.1.</p>
</blockquote>
<p>So I have a little digging to do to verify what happens when the initial connection is made over http/2.</p>
<p>An example upgrade request from the same MDN upgrade docs:</p>
<div class="gatsby-highlight">
      <pre class="language-text"><code class="language-text">GET /index.html HTTP/1.1
Host: www.example.com
Connection: upgrade
Upgrade: example/1, foo/2</code></pre>
      </div>
<p>and a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Protocol_upgrade_mechanism#upgrading_to_a_websocket_connection">specific section for the upgrade to websocket protocal</a>. I will say, the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/101">101 Switching Protocols http response status code</a> is not one I was familiar with. Interview questions, I guess.</p>
<h2>What does production look like for websockets?</h2>
<ul>
<li>heartbeat?</li>
<li>wss connection</li>
<li>token expiration if the socket is open for more than token life span</li>
<li>does logging / apm agent actually monitor websockets? appears some don't.</li>
</ul>
<p>Recommendations</p>
<ul>
<li>Base autoscaling on number of open connections because things like CPU will often be misleading as open connections will often remain idle.</li>
</ul>
<h2>Other links I used in building this.. that probably mean I had things to learn or lock into memory and needed to come back to.</h2>
<h3>Getting it going...</h3>
<ul>
<li><a href="https://blog.mrg.sh/build-a-websocket-server-using-express-and-ws-package">https://blog.mrg.sh/build-a-websocket-server-using-express-and-ws-package</a></li>
<li><a href="https://github.com/trevtrich/websocket-live-eventing">https://github.com/trevtrich/websocket-live-eventing</a></li>
<li><a href="https://www.npmjs.com/package/ws#sending-and-receiving-text-data">https://www.npmjs.com/package/ws#sending-and-receiving-text-data</a></li>
<li><a href="https://github.com/websockets/ws/blob/c82b08737fbe142dd910fc7e429399e23b95c6d6/examples/express-session-parse/index.js">https://github.com/websockets/ws/blob/c82b08737fbe142dd910fc7e429399e23b95c6d6/examples/express-session-parse/index.js</a></li>
<li><a href="https://codehandbook.org/how-to-render-html-page-in-express/">https://codehandbook.org/how-to-render-html-page-in-express/</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications#receiving_messages_from_the_server">https://developer.mozilla.org/en-US/docs/Web/API/WebSockets<em>API/Writing</em>WebSocket<em>client</em>applications#receiving<em>messages</em>from<em>the</em>server</a></li>
<li><a href="https://attacomsian.com/blog/javascript-update-element-text">https://attacomsian.com/blog/javascript-update-element-text</a></li>
<li><a href="https://cloud.google.com/pubsub/docs/reference/libraries#client-libraries-install-nodejs">https://cloud.google.com/pubsub/docs/reference/libraries#client-libraries-install-nodejs</a></li>
<li><a href="https://console.cloud.google.com/cloudpubsub/topic/detail/test-messages?authuser=1&#x26;project=websocket-server-334803&#x26;tab=messages">https://console.cloud.google.com/cloudpubsub/topic/detail/test-messages?authuser=1&#x26;project=websocket-server-334803&#x26;tab=messages</a></li>
<li><a href="https://stackoverflow.com/questions/40032678/where-are-google-application-default-credentials-stored">https://stackoverflow.com/questions/40032678/where-are-google-application-default-credentials-stored</a></li>
</ul>
<h3>Production</h3>
<ul>
<li><a href="https://medium.com/voodoo-engineering/websockets-on-production-with-node-js-bdc82d07bb9f">https://medium.com/voodoo-engineering/websockets-on-production-with-node-js-bdc82d07bb9f</a></li>
</ul></div><!-- react-text: 23 --><!-- /react-text --><div class="footer" data-reactid="24"><hr class="border-primary" data-reactid="25"/><p data-reactid="26"><!-- react-text: 27 -->Trevor Richardson<!-- /react-text --><a href="/profile/" data-reactid="28"><br data-reactid="29"/><strong data-reactid="30">richardson-trevor</strong><!-- react-text: 31 --> on Profile<!-- /react-text --></a></p></div></div></div></div></div></div></div><script id="webpack-manifest">/*<![CDATA[*/window.webpackManifest={"231608221292675":"app-e169fb4d80d59c873b74.js","107818501498521":"component---src-templates-blog-post-js-bb3d61544a2bc4b0eeb1.js","35783957827783":"component---src-pages-index-js-623bf38456ef60a8620d.js","261381953904780":"component---src-pages-profile-index-jsx-03b222419e7315573b49.js","60335399758886":"path----557518bd178906f8d58a.js","16949292511778":"path---articles-hello-world-869359bec94272f1f58e.js","62714314466750":"path---articles-task-managers-6c5f128c919320ac4983.js","261017781101503":"path---articles-why-start-4a1c5e54901c7d079359.js","109475572554997":"path---articles-good-to-great-8644b7b7c5b1dbdac139.js","220762797345579":"path---articles-all-the-wealth-feafd127da904eaca172.js","211685770631153":"path---articles-using-vim-5a48f0e558ec252a601f.js","53222572955646":"path---articles-rest-in-practice-8d0602a88a2176078b32.js","21373376276538":"path---articles-if-you-re-afraid-of-it-build-something-with-it-466d9568ef010bcdd155.js","211201678629729":"path---articles-restful-web-services-f47bd0c917407e134178.js","111417940544700":"path---articles-how-google-tests-software-45890badae000b5b33d3.js","23805019638589":"path---articles-review-the-tangled-web-c0fd09bb4e8dcb1f0aed.js","123414460862395":"path---articles-principles-1781735003db4a20ced0.js","64659104052425":"path---articles-follow-the-scent-of-your-tests-7f874ccabab351abd258.js","7671606436013":"path---articles-are-integration-tests-only-a-problem-because-of-design-5696d15a00980ce367e3.js","39618939889838":"path---articles-til-a-little-jq-with-xargs-ebd8d13d6f8073b83539.js","12392048024316":"path---articles-til-revert-multiple-commits-b3d8aeeb43c5349ebf50.js","80672067657709":"path---articles-til-using-find-with-extended-regex-9b33920c4760d4c1e06d.js","180292218488704":"path---articles-til-use-jq-to-find-all-elements-with-an-array-property-of-given-length-5d477c16b49403516a24.js","88089139061920":"path---articles-til-center-code-in-jet-brains-editors-b4ff3772d26dd9383297.js","44310624679719":"path---articles-diff-json-blobs-with-jq-and-vimdiff-c2de62739c53118de60b.js","176464930076895":"path---articles-grrr-git-says-my-directory-isn-t-clean-948cb40e81e08ecee184.js","166579220904342":"path---articles-delete-all-but-branches-but-master-61e2021fa789828811c2.js","77346033005119":"path---articles-close-all-vim-tabs-to-the-right-1ff02f52e054ddc6d8d1.js","230042148936571":"path---articles-foray-into-websockets-pt-2-a522d7b37de98a0c5c80.js","191193763155498":"path---articles-foray-into-websockets-f4de3c92ec27bfe6288f.js","142629428675168":"path---index-90e1f9390e430e95e268.js","62474309173725":"path---profile-a0e39f21c11f6a62c5ab.js","114276838955818":"component---src-layouts-index-js-a4e5ddf799ebaf8598d9.js"}/*]]>*/</script><script>/*<![CDATA[*/["/commons-17ad36fa7d6346d3a748.js","/app-e169fb4d80d59c873b74.js","/path---articles-foray-into-websockets-pt-2-a522d7b37de98a0c5c80.js","/component---src-templates-blog-post-js-bb3d61544a2bc4b0eeb1.js","/component---src-layouts-index-js-a4e5ddf799ebaf8598d9.js"].forEach(function(s){document.write('<script src="'+s+'" defer></'+'script>')})/*]]>*/</script></body></html>